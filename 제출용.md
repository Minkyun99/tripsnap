# 🥐 TRIPSNAP – 시간 효율 최적화 기반 맞춤형 대전 빵집 빵지순례 추천 시스템

**Team PAPAPAK**
- **최연제(팀장)**
  - 데이터 수집 및 정제
  - 챗봇 모델링
  - 챗봇 페이지 구현
  - 서버 배포
- **김민경**
  - 데이터 수집 및 정제
  - 키워드 추출 모델 개발
  - 챗봇 모델링
  - 프로필 페이지 및 커뮤니티 기능 구현
  - 회원가입, 로그인, 로그아웃 기능 구현

#### 브랜치 전략
- `main` : 배포 가능 상태
- `develop` : 로컬에서 기능 구현 완료 상태
- `feature/yeonjae`, `feature/minkyung` : 각자 기능별 구현
![alt text](제출용img/image.png)  
![alt text](제출용img/image-1.png)

---

## 📌 프로젝트 개요

TRIPSNAP은 사용자가 일일이 빵집 정보를 검색하지 않아도,  
사용자의 **위치 / 방문 시간 / 이동수단 / 취향 키워드**를 종합적으로 반영하여  
**최적의 빵집 방문 루트(빵지순례)를 자동 추천하는 AI 서비스**입니다.

- 단순한 빵집 추천이 아닌  
  → `맞춤형 추천 + 이동 동선 최적화 + 시간 효율`  
  을 동시에 해결하는 대전 지역 특화 빵지순례 플랫폼입니다.

---

## 🎯 프로젝트 목표

- ✔ 사용자의 빵집 탐색 시간·노력 최소화
- ✔ 개인 취향 기반 맞춤형 빵집 추천 제공
- ✔ 이동 동선, 영업 여부, 대기 시간까지 반영한 “실제 방문 가능한” 루트 생성
- ✔ 커뮤니티 활동 데이터 기반, 학습되는 추천 시스템 구현
- ✔ LLM + Vector DB + 딥러닝 키워드 모델을 활용한 고품질 추천 경험 제공

---

## 🧁 주요 기능 (Core Features)

### 1️⃣ 빵지순례 루트 자동 추천

- 입력: 위치 / 이동수단 / 방문 시간 / 키워드
- 도보·대중교통을 고려한 동선 기반 추천
- 영업 중인 매장만 필터링
- 방문 순서·루트를 함께 제시

#### 내부 모듈 구성(도메인 로직 분리)

- **location_module**
  ![alt text](<제출용img/스크린샷 2025-12-26 002746.png>)
  - extract_location_from_query : 자연어에서 위치/행정구역/좌표 추출
  - filter_bakeries_by_location : 위치 기반 후보 필터링
  - detect_transport_mode : 도보/대중교통/자차 인식
  - find_nearest_subway_station : 지하철역 근접 매장 처리
  - annotate_admin_areas : 구/동 메타데이터 주입
  - haversine, build*kakao*\*\_url 등 위치/거리/지도 유틸
- **time_module**
  ![alt text](제출용img/time_module.png)
  - build_business_hours_index : 요일별 영업시간 인덱스
  - is_open_at, is_available_in_period : 시점/기간 기준 영업 여부
  - parse_date_time_from_query, DateTimeParser : 자연어에서 날짜/시간 범위 파싱
  - KOREAN_WEEKDAY_MAP : 요일 매핑
- **ranking_module**
  ![alt text](제출용img/ranking_module.png)
  - build_review_stats_cache : 리뷰 키워드 통계 캐시
  - compute_popularity_score : 인기도 점수(리뷰 수, 평점 기반)
  - extract_menu_keywords : 질문에서 메뉴 키워드 추출
  - generate_search_queries : 벡터 검색용 쿼리 생성
  - detect_flagship_tour_intent : “빵지순례/대표 코스” 의도 분석
  - rank_bakeries : 최종 점수 계산 및 1차 랭킹
- **ranking_utils**
  ![alt text](제출용img/ranking_utils.png)
  - haversine_distance_km, estimate_walk_time_minutes, estimate_transit_time_minutes
  - \_safe_rating : 여러 평점 필드 통합/보정용

#### 구현 기능 정리

- **질의 타입 분류**
  - \_infer_query_type(query)
    - 세 가지로 분류:
      1. recommend: 빵집/코스 추천
      2. knowledge: 빵·디저트 지식/이론 설명
      3. irrelevant: 도메인 밖(라멘, 고기, 술집 등만 언급) → 답변 거절
    - 규칙 기반:
      - 빵/디저트 관련 토큰, base_keywords의 메뉴 키워드, 영어 제과 용어,
      - “맛집/추천/코스” 여부, “?” 포함 여부 등.

#### 위치·교통·시간 인식

- **위치(LocationFilter)**
  ![alt text](제출용img/location_query.png)

  - 자연어에서 행정구역, 역, 지번/도로명 등을 분석해
    - kind="point" (lat, lon),
    - 또는 구/동 범위 필터로 사용.
  - filter_bakeries_by_location로 1차 공간 필터링.

- **이동 수단(TransportMode)**
  ![alt text](제출용img/transit_query.png)

  - “도보/걸어서/버스/지하철/자차/드라이브…” 등을 인식.
  - 없으면 기본값은 대중교통(transit).

- **날짜·시간(DateTimeConstraint)**
  ![alt text](제출용img/extract_date.png)

  - “지금/바로”, “오늘 오후 3시”, “12월 25일~26일 21:00까지” 등
    - start_date, end_date, start_time, end_time,
    - use_now_if_missing 플래그로 구조화.
  - has_date_range 여부에 따라 코스 기간 설명 문구 분기.

- **‘지금/바로’ 의도**
  ![alt text](제출용img/tiem_now.png)
  - \_has_now_intent(query)
  - “지금, 바로, 당장, 현재” 등을 인식해,
    - 시간 지정이 없더라도 현재 시각 기준 영업 중 매장 위주로 필터링.

#### 벡터 검색 및 후보 생성

![alt text](제출용img/ranking.png)

1. generate_search_queries()

- 사용자 질문 + 메뉴 키워드 + 위치 정보 기반으로 복수의 검색 쿼리 문자열 생성.

2. \_vector_search_bakeries()

- Upstage 임베딩으로 각 쿼리 임베딩 생성 → Chroma bakery_collection.query.
- 반환된 ids, distances로 slug별 스코어 집계.
- 실패 시 전체 매장 fallback.

3. filter_bakeries_by_location()
   행정구역/반경 기반으로 1차 후보 필터.
4. \_filter_candidates_by_travel_time_from_origin()

- 사용자 좌표 기준으로
  - 도보: 20분
  - 대중교통: 30분
  - 자차: 40분
- 이내로 도달 가능한 매장만 남김 (Kakao Mobility 거리/시간 사용, 실패 시 추정값).

#### 랭킹 및 동선 최적화

- **1차 랭킹**: rank_bakeries()
  - 메뉴 키워드 매칭 강도
  - 평점/리뷰 수/인기도 점수
  - 카페/커피 비중, 브랜드 중복 여부 등 반영 (기존 모듈에서 계산).
- **메뉴 조건 너무 빡세서 0개일 때 보정**

  - 메뉴 키워드 제거 후 한 번 더 랭킹 시도.

- **2차 동선 최적화**: \_order_bakeries_by_route()

  - **지하철 모드(transit)**:

    - 대전 1호선 고정 역 순서(SUBWAY_LINE1_SEQUENCE)
    - 각 매장을 가까운 역 기준으로 클러스터링 → 역 index 순서로 진행.
    - 출발역은
      - 사용자 위치와 가장 가까운 역 클러스터,
      - 또는 가장 인기 높은 클러스터 기준.

  - **도보/자차 모드**:

    - \_order_bakeries_by_route_distance()
      - origin 기준 또는 가장 점수 높은 매장을 시작점으로
      - composite = route_score - α \* distance_km 최대화하는 거리+인기도 그리디 경로.
      - 도보 모드: 구간별 최대 거리(max_leg_km)를 제한 → “도보 20분 룰” 강제.

  - **역 주변 과밀 매장 정리: (보조용 \_prune_far_same_station_bakeries)**
    - 동일 지하철역에 몰린 매장 중,
    - 가장 점수 높은 매장을 anchor로 두고,
    - 도보 25분 이내는 포함, 너무 떨어진 곳은 제거.

#### 대기시간·영업시간 반영

- 영업시간 인덱스: build_business_hours_index

  - 매장별 0~6 요일, open/close 정보를 인덱싱.

- **대기시간 추정**: \_get_expected_wait_minutes()

  - waiting_prediction.predictions[요일][time_band].predicted_wait_minutes
  - overall_stats.average_minutes
  - 주말·공휴일·리뷰 수(인기도) 등에 따라 가중치 적용.

- **코스 시간 시뮬레이션 (render_answer)**
  - 매 매장마다:
    - 이전 매장 → 현재 매장 이동 시간
    - 오픈 전 대기(wait_for_open)
    - 줄 서는 시간(base_wait)
    - 매장 체류 시간(평균 15분)
  - 누적하여
    - “예상 도착 시각 / 다음 매장 출발 시각” 계산·표시.
  - **시작 시각 자동 추론: \_decide_start_minutes_for_answer()**
    - 사용자가 시간 지정 X + ‘지금/바로’ X 인 경우
      - 인기 매장(리뷰 ≥ 500, 인기도 점수 기준)의 **가장 이른 오픈 시간 (07:00~12:30 사이)**를 기준으로 출발 시각 추천.
      - 적절한 후보 없으면 기본 11:00.

#### 답변 생성 및 설명

- 헤더 + 디버깅 로그

  - 질의 타입, 추출된 위치·시간·메뉴 키워드, 벡터 검색 쿼리, 필터링 과정 등
  - 내부 로그를 자세히 문자열로 출력(개발·검증용).

- **매장별 상세 블록**
  - 매장명, 위치, 주소
  - 통합 평점(추정), 리뷰 수, 인기도 점수
  - 카카오맵 위치/길찾기 URL
  - 지하철역 기준 접근 방법(역명, 환승 도보 시간)
  - 예상 이동 시간/대기 시간/체류 시간·도착/출발 시각
  - 리뷰 키워드 상위 5개 + 등장 횟수
  - 대표 메뉴/키워드 목록
  - 전문가 코멘트(빵지순례 관점)
- **코스 설계 이유 요약**

  - 메뉴 초점 여부(특정 메뉴 vs 전체 인기)
  - 지하철/도보/자차 클러스터링 논리
  - “도보 20분 룰” 적용 여부
  - Kakao Mobility API 사용 여부
  - 전체 이동·대기 시간 합계 및 유의사항.

  #### 프롬프트 설정

  ![alt text](제출용img/prompt.png)

### 2️⃣ 개인 맞춤형 추천 (커뮤니티 기반)

- 사용자의 커뮤니티 글에서 빵 관련 키워드 자동 추출
- “소금빵”, “크루와상”, “버터 풍미”, “쫀득한 식감” 등 취향 요소 벡터화
- 메인 화면에 개인 맞춤형 빵집 자동 추천

### 3️⃣ LLM 기반 챗봇 인터페이스

- 자연어로 조건을 자유롭게 입력
- 복합 조건(기간, 시간대, 이동수단, 메뉴 등) 자동 해석
- 추천 근거·이유를 LLM이 설명

### 4️⃣ 커뮤니티 기능

- 추천 받은 빵집을 게시글로 공유
- 좋아요 / 댓글 / 스크랩
- 본인의 빵 취향 히스토리 확장

---

## 🏗 시스템 아키텍처

### 🔧 기술 스택

| 영역        | 기술                                            |
| ----------- | ----------------------------------------------- |
| Frontend    | Vue3                                            |
| Backend     | Django REST Framework                           |
| DB          | RDB (PostgreSQL/MySQL 등) + Chroma 등 Vector DB |
| AI / LLM    | OpenAI API + RAG 구조                           |
| NLP         | KoELECTRA 기반 키워드 추출 모델                 |
| 지도        | Kakao Map API                                   |
| 데이터 수집 | Naver Place / Kakao Map / 블로그 크롤링         |

### 🔁 전체 흐름 개요

1. 사용자가 웹 프론트(Vue3)에서 챗봇/검색/커뮤니티 이용
2. Django REST API 서버가 요청 처리
3. 빵집·리뷰·유저 데이터는 RDB에서 조회
4. 의미 기반 검색은 Vector DB(Chroma)에 질의
5. LLM이 Vector DB 검색 결과 + 규칙 기반 로직을 바탕으로 추천을 생성
6. 결과를 구조화된 형태(카드, 리스트, 루트 정보)로 FE에 반환

---

## 🧬 데이터 파이프라인

1️⃣ **데이터 수집**

- 퍼플렉시티 등 AI 사이트와 네이버 블로그 등에서 빵집/카페 데이터 수집
- 매장 기본 정보 + 리뷰 텍스트 + 평점 + 위치 + 영업시간

2️⃣ **데이터 정제**

- 중복 매장 제거
- 노이즈 리뷰/광고성 텍스트 정리
- 주소·위치 좌표 정규화

3️⃣ **리뷰 분석 및 평점 통합**

- 네이버 리뷰 텍스트 → 감성 분석 / 평점 변환

4️⃣ **키워드 추출**

- KoELECTRA 기반 키워드 분류 모델로 빵/맛/분위기/웨이팅 등 주요 키워드 태깅

5️⃣ **임베딩 & Vector DB 저장**

- 정제된 최종 데이터(jhgan/ko-sroberta-multitask 등 모델로 임베딩)
- Vector DB에 저장해 RAG 기반 추천에 활용

---

## 🤖 키워드 추출 딥러닝 모델

![alt text](제출용img/model_1.png) ![alt text](제출용img/model_2.png) ![alt text](제출용img/model_3.png) ![alt text](제출용img/model_4.png) ![alt text](제출용img/model_5.png) ![alt text](제출용img/model_6.png) ![alt text](제출용img/model_7.png) ![alt text](제출용img/model_8.png) ![alt text](제출용img/model_9.png) ![alt text](제출용img/model_10.png)

- **모델**: KoELECTRA 기반 커스텀 파인튜닝
- **입력**: 블로그 리뷰 등 자연어 텍스트
- **출력**: 빵 관련 단어 및 카테고리 키워드
  - 메뉴: 소금빵, 크루와상, 식빵, 케이크 등
  - 맛 표현: 버터 풍미, 쫀득한, 촉촉한, 담백한 등
  - 분위기: 감성 카페, 넓은 좌석, 조용한 등
  - 웨이팅: 줄 서는, 웨이팅 필수, 인기 많은 등

예시:

```text
"버터 향이 진하고 결이 살아있는 크루와상, 웨이팅 있어도 먹을만해요"
→ ["크루와상", "버터 풍미", "식감 좋음", "웨이팅"]
```

- 해당 키워드들은:

1. 개인 취향 프로필 생성
2. 추천 점수 계산에 반영
3. LLM 프롬프트로 전달되어 설명 생성에도 활용

## 🧠 추천 알고리즘 개요

![alt text](제출용img/chatbot-1.png) ![alt text](제출용img/chatbot-2.png) ![alt text](제출용img/chatbot-3.png) ![alt text](제출용img/chatbot-4.png)

### 입력 요소

- 사용자의 자연어 요청
- 위치 정보(좌표 / 행정구역)
- 이동수단(도보 / 대중교통)
- 방문 가능 시간대(지금 / 특정 날짜 범위)
- 메뉴·맛 관련 키워드
- 평점 / 인기 / 리뷰 수
- 개인 취향 벡터(커뮤니티 활동 기반)

### 처리 흐름

1. 위치 기준 1차 필터링
2. 영업 시간 / 요일 / 현재 시간 기준 방문 가능 매장만 남김
3. 이동수단(도보/대중교통)에 따라 허용 거리/시간 필터링
4. 키워드 매칭 점수 계산 (메뉴, 맛, 분위기 등)
5. 평점 + 인기(리뷰 수) + 키워드 점수 + 개인 취향 점수 가중 합산
6. 휴리스틱 알고리즘 경로 최적화(동선 상 가까운 순서)로 방문 순서 산출
7. Top-N 매장 + 방문 루트 반환

### 🧾 LLM + RAG 구조

#### 역할 분리

- Vector DB:
  - “어떤 빵집이 후보가 될 수 있는가?”를 찾음
- LLM:

  - 사용자의 자연어 의도 해석
  - 추천 결과를 설명형 문장으로 생성
  - 조건(시간, 대기, 이동수단 등)을 언어적으로 풀어 사용자에게 전달

- RAG 처리 흐름
  사용자 질문  
   → (임베딩) → Vector DB에서 유사도 높은 빵집/리뷰 검색  
   → 검색 결과 + 사용자 조건을 기반으로 LLM 프롬프트 구성  
   → LLM이 최종 답변/추천 코스 생성

#### 장점

- 단순 규칙 기반 추천이 아닌 “근거 있는 추천”
- 최신 데이터에 대한 확장 용이
- 모델이 임의로 지어내기(Hallucination) 위험 감소

## 🗄 ERD 개요 (Database Modeling)

본 프로젝트에서는 **관계형 DB(RDB)**와 Vector DB를 함께 사용합니다.

### 1️⃣ 주요 엔터티 (RDB)

- User
  - id, email, password, 가입일 등
- Profile
  - user(1:1), nickname, profile_img, 자기소개 등
- Bakery
  - id, name, address, district, latitude, longitude, phone, 카테고리, 영업시간 등
- BakeryKeyword
  - bakery(N:1), keyword, type(메뉴/맛/분위기/웨이팅 등), weight
- ReviewSummary
  - bakery(N:1), source(네이버/블로그), summary_text, sentiment_score, review_count
- WaitingStat
  - bakery(N:1), day_of_week, time_slot, avg_waiting_minutes
- Post (커뮤니티 게시글)
  - author(User), title, content, created_at, 공개 여부, 관련 빵집 참조(optional)
- Comment
  - post(N:1), author(User), content, created_at
- Like
  - post(N:1), user(N:1), created_at
- Scrap / SavedRoute
  - user, 빵집 목록 or 추천 루트 정보를 저장

### 2️⃣ ER 다이어그램 (개략적 Mermaid 예시)

![alt text](제출용img/tripsnap_erd.png)

### 3️⃣ Vector DB 구조

- bakery_embeddings
  - bakery_id, description_embedding
- keyword_embeddings
  - keyword, embedding
- review_embeddings - review_id(or summary_id), embedding
  → RDB의 PK를 Vector DB 문서 ID와 연결하여,
  “Vector 검색 → RDB 상세 조회” 패턴으로 동작합니다.

## 🖼 화면 정의서 (주요 화면 설계)

![alt text](제출용img/tripsnap-LG100.png) ![alt text](제출용img/tripsnap-LG101.png) ![alt text](제출용img/tripsnap-MP200.png) ![alt text](제출용img/tripsnap-MP201.png) ![alt text](제출용img/tripsnap-PF400.png)

### 1️⃣ 로그인 / 회원가입 화면 (LG / OB)

- 이메일 + 비밀번호 기반 로그인
- 이메일 + 비밀번호 + 닉네임 회원가입
- 소셜 로그인(Kakao 등) 확장 가능 구조
- **주요 요소**
- 이메일 입력 필드
- 비밀번호 입력 필드
- 로그인 / 회원가입 버튼
- 로그인 성공 시 메인 페이지(MP)로 이동

### 2️⃣ 메인 / 챗봇 화면 (MP / CS)

- 상단 글로벌 네비게이션 바(Nav)
  - 로고(TRIPSNAP)
  - 메뉴: Chat, Community, Profile
- 중앙 영역: 챗봇 화면
  - 사용자 입력 인풋 박스
  - 전송 버튼
  - 챗봇/사용자 메시지 버블 리스트
  - 추천 빵집 카드 표시 (이름, 위치, 평점, 키워드, “자세히 보기” 버튼)

**기능**

- 자연어로 빵집/루트 추천 질의
- 추천 결과 카드화
- 추천 빵집 “저장” / “공유” 버튼 제공

### 3️⃣ 커뮤니티 화면 (CM)

- 상단: “추천 빵집 공유하기” 버튼
- 메인 리스트: 다른 사용자들이 공유한 빵지순례 루트 / 빵집 추천 게시글
  - 썸네일 이미지
  - 제목, 작성자, 작성일
  - 간단한 빵집 리스트(대표 1~2곳)
- 게시글 상세
  - 추천 이유, 방문 동선 설명
  - 관련 빵집 리스트 (카드 형태)
  - 좋아요 / 댓글 / 스크랩 버튼

4️⃣ 프로필 화면 (PF)

- 상단: 프로필 정보
  - 프로필 이미지
  - 닉네임, 이메일
  - 팔로워 / 팔로잉 / 게시글 수 (선택)
- 중간:
  - 내가 쓴 커뮤니티 글 목록
  - 내가 저장한 빵집 / 루트 목록
- 하단:
  - 비밀번호 변경 섹션
  - 회원 탈퇴 버튼 (재확인 팝업)

### 5️⃣ 추천 루트 상세 화면 (선택/고도화 영역)

- 제목: “대전역 출발 3곳 빵지순례 코스”
- 지도 뷰: 각 빵집 위치 마커 표시 (Kakao Map)
- 하단 리스트:
  1. 1코스: 빵집 A (예상 이동시간, 추천 메뉴)
  2. 2코스: 빵집 B (예상 이동시간, 추천 메뉴)
  3. 3코스: 빵집 C …

## 🎯 목표 서비스 vs 실제 구현 정도

| 구분          | 목표 서비스                            | 실제 구현 범위(현 버전)                                                             |
| ------------- | -------------------------------------- | ----------------------------------------------------------------------------------- |
| 지역 범위     | 전국 단위 빵집 / 카페 / 디저트         | 대전 지역 중심 빵집 데이터에 대한 추천 기능 우선 구현                               |
| 추천 단위     | 여행 코스(도시 간, 관광지 포함) + 빵집 | 대전 시내 빵집 중심 빵지순례 루트 추천                                              |
| 데이터 수집   | 실시간/정기적 크롤링 및 자동 업데이트  | Naver / Kakao 기반 수집 및 정제된 정적 데이터셋 사용 (일부 수동 업데이트)           |
| 대기시간 반영 | 실시간 대기시간 / 혼잡도 반영          | 요일·시간대별 평균 대기시간 기반 함수 및 구조 설계 (예측 모델/실시간은 단계적 적용) |
| 이동수단      | 도보 / 대중교통 / 자차까지 확장        | 도보/대중교통 위주 로직 및 Kakao Map 활용 기반 구조 구현                            |
| LLM 활용      | 멀티 에이전트 기반 고도 대화           | 단일 챗봇 플로우에서 RAG + 프롬프트 설계 기반 추천/설명 제공                        |
| 개인화        | 장기 사용 로그 기반 정교한 추천        | 커뮤니티 키워드 기반 사용자 취향 모델링 및 메인 화면 자동 추천 구현                 |
| 상용화        | 실서비스 배포 및 운영 인프라 구축      | 로컬/개발 환경 기준 API/모델 연동 및 프로토타입 완성                                |

**요약:**
데이터·모델링·RAG·추천 로직의 핵심 구조는 실제 구현되었고,
전국 확장 / 실시간 대기 예측 / 멀티 에이전트 / 상용 인프라는
“향후 고도화 단계”로 설계되어 있습니다.

## 👤 사용자 시나리오 예시

Q. "대전역 근처에서 지금 바로 도보로 갈 수 있는 소금빵 맛집 추천해줘"

1. 위치: '대전역' 근처 좌표 인식
2. 이동수단: 도보 → 허용 거리/시간 필터 설정
3. 시간: 현재 시각 기준 영업 중 매장만 필터링
4. 키워드: '소금빵' 관련 키워드 매칭
5. 평점/인기/취향 가중치로 스코어링
6. 최적 동선 순으로 2~3곳 추천 + 설명 제공

## 🔍 성능 및 검증 방향

- 키워드 추출 정확도: 약 85% 이상을 목표로 모델 튜닝
- 추천 응답 속도: 3~5초(LLM 호출 포함) 수준 유지 목표
- 사용자 평가:
  - “추천 만족도”, “설명 이해도”, “방문 의향” 중심 설문 설계 가능

## 🚀 향후 개발 계획

- 대전 → 전국 확장(서울, 부산 등 주요 도시)
- 빵 → 카페 / 디저트 / 여행지(관광 코스) 영역 확장
- Agent 기반 고도화(“일정 전체를 설계해 주는 여행 플래너” 역할)
- 실시간 대기시간/혼잡도 추정 모델 추가
- 상권 협업 및 상용 서비스로 확장

# 👥 팀 정보

### Team PAPAPAK

- AI / 딥러닝 모델링
- RAG 파이프라인 설계
- 데이터 엔지니어링
- Django 백엔드 개발
- Vue3 프론트엔드 개발
- 서비스 기획 및 UX 설계
