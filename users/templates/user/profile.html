{% extends "base/index.html" %} {% load static %} {% block title %}{{
target_user.nickname }} - í”„ë¡œí•„{% endblock title %} {% block content %}
<main class="p-6">
  <div
    class="max-w-5xl mx-auto bg-white/90 rounded-2xl border-4 border-[#D2691E] pixel-corners"
  >
    <!-- ===== í”„ë¡œí•„ í—¤ë” ===== -->
    <div
      class="bg-gradient-to-r from-[#FF69B4] to-[#FFB6C1] p-8 border-b-4 border-[#D2691E] flex flex-col md:flex-row gap-6 items-center relative"
    >
      <a
        href="{% url 'users:settings' %}"
        class="absolute top-3 right-3 bg-white/90 text-[#D2691E] rounded-full p-2 shadow hover:bg-white transition"
      >
        âš™ï¸
      </a>

      <!-- PROFILE IMAGE -->
      <div class="relative">
        {% if profile.profile_img %}
        <img
          id="profileImage"
          src="{{ profile.profile_img.url }}"
          class="w-32 h-32 rounded-full ring-4 ring-white shadow-xl object-cover cursor-pointer"
          {%
          if
          is_owner
          %}onclick="openImagePopup()"
          {%
          endif
          %}
        />
        {% else %}
        <div
          id="profileImage"
          class="w-32 h-32 bg-white rounded-full ring-4 ring-white shadow-lg text-6xl flex justify-center items-center cursor-pointer"
          {%
          if
          is_owner
          %}onclick="openImagePopup()"
          {%
          endif
          %}
        >
          ğŸ
        </div>
        {% endif %} {% if is_owner %}
        <button
          onclick="openImagePopup()"
          class="absolute bottom-0 right-0 bg-[#FF69B4] text-white border-2 border-white rounded-full p-2 shadow"
        >
          âœï¸
        </button>
        {% endif %}
      </div>

      <!-- PROFILE INFO -->
      <div class="flex-grow text-center md:text-left text-white">
        <h2 class="text-4xl font-extrabold mb-1">{{ target_user.nickname }}</h2>
        <p class="text-lg opacity-80 mb-4">@{{ target_user.username }}</p>

        <div class="flex gap-6 justify-center md:justify-start">
          <!-- íŒ”ë¡œì›Œ ìˆ˜ + ëª¨ë‹¬ -->
          <button
            type="button"
            onclick="openFollowModal('followers')"
            class="text-center cursor-pointer"
          >
            <p class="text-2xl font-bold underline" id="followerCount">
              {{ follower_count }}
            </p>
            <p class="text-sm opacity-80">íŒ”ë¡œì›Œ</p>
          </button>

          <!-- íŒ”ë¡œì‰ ìˆ˜ + ëª¨ë‹¬ -->
          <button
            type="button"
            onclick="openFollowModal('followings')"
            class="text-center cursor-pointer"
          >
            <p class="text-2xl font-bold underline" id="followingCount">
              {{ following_count }}
            </p>
            <p class="text-sm opacity-80">íŒ”ë¡œì‰</p>
          </button>
        </div>

        <!-- ===== FOLLOWERS / FOLLOWINGS MODAL ===== -->
        <div
          id="followModal"
          class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
        >
          <div class="bg-white rounded-2xl max-w-sm w-full p-6 relative">
            <button
              type="button"
              onclick="closeFollowModal()"
              class="absolute top-3 right-3 w-7 h-7 flex items-center justify-center rounded-full bg-black/60 text-white text-xs"
            >
              âœ•
            </button>

            <h3
              id="followModalTitle"
              class="text-xl font-bold text-[#D2691E] mb-4"
            >
              íŒ”ë¡œì›Œ
            </h3>

            <div
              id="followList"
              class="space-y-3 max-h-80 overflow-y-auto text-sm"
            >
              <!-- JS ë¡œ ì±„ì›€ -->
            </div>
          </div>
        </div>

        {% if not is_owner %}
        <button
          id="followBtn"
          onclick="toggleFollow('{{ target_user.nickname }}')"
          class="mt-4 px-6 py-3 text-lg font-bold rounded-xl pixel-corners border-3 transition shadow {% if is_following %}bg-white text-[#D2691E] border-[#D2691E]{% else %}bg-[#FF69B4] text-white border-[#D2691E]{% endif %}"
        >
          {% if is_following %}âœ” íŒ”ë¡œì‰{% else %}+ íŒ”ë¡œìš°{% endif %}
        </button>
        {% endif %}
      </div>
    </div>

    <!-- ===== ë‹¤ë¥¸ ì‚¬ëŒ í”„ë¡œí•„ ê²€ìƒ‰ ë°” ===== -->
    <div class="px-8 pt-6">
      <form
        method="get"
        action="{% url 'users:profile_search' %}"
        class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center bg-[#FFF5E6] px-4 py-3 rounded-xl border border-[#D2691E]/40"
      >
        <label class="text-sm font-semibold text-[#8B4513] sm:w-auto">
          ë‹¤ë¥¸ ì‚¬ëŒ í”„ë¡œí•„ ê²€ìƒ‰
        </label>
        <input
          type="text"
          name="q"
          placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
          class="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FF69B4]"
        />
        <button
          type="submit"
          class="px-4 py-2 bg-[#FF69B4] text-white text-sm font-bold rounded-lg border-2 border-[#D2691E] hover:bg-[#FF1493] transition"
        >
          ê²€ìƒ‰
        </button>
      </form>
    </div>

    <!-- ===== ê²Œì‹œê¸€ ì—…ë¡œë“œ (ë³¸ì¸ë§Œ) ===== -->
    {% if is_owner %}
    <div class="p-6">
      <form
        method="post"
        action="{% url 'users:post_create' %}"
        enctype="multipart/form-data"
        class="bg-[#FFF5E6] p-5 border-2 border-dashed border-[#D2691E] rounded-xl space-y-3"
      >
        {% csrf_token %}
        <input
          name="title"
          placeholder="ì œëª© ì…ë ¥"
          class="w-full px-4 py-2 border rounded-lg"
        />
        <textarea
          name="content"
          class="w-full px-4 py-2 border rounded-lg"
          rows="2"
          placeholder="ë‚´ìš© ì‘ì„±"
        ></textarea>
        <input type="file" name="share_trip" class="w-full" />
        <div class="text-right">
          <button
            class="bg-[#FF69B4] text-white px-6 py-2 rounded-xl border-2 border-[#D2691E]"
          >
            ê²Œì‹œê¸€ ì˜¬ë¦¬ê¸°
          </button>
        </div>
      </form>
    </div>
    {% endif %}

    <!-- ===== ê²Œì‹œê¸€ ê·¸ë¦¬ë“œ ===== -->
    <div class="p-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for post in posts %}
        <!-- ì¹´ë“œ ì „ì²´ í´ë¦­ ê°€ëŠ¥ -->
        <div
          class="rounded-xl border bg-white overflow-hidden cursor-pointer post-card"
          data-id="{{ post.id }}"
          data-img="{% if post.share_trip %}{{ post.share_trip.url }}{% endif %}"
          data-title="{{ post.title|escapejs }}"
          data-content="{{ post.content|escapejs }}"
          data-writer="{{ post.writer.username }}"
          data-likes="{{ post.likes.count }}"
          data-liked="{% if post.id in liked_post_ids %}true{% else %}false{% endif %}"
          onclick="openPostModal(this)"
        >
          {% if post.share_trip %}
          <img
            src="{{ post.share_trip.url }}"
            class="w-full h-48 object-cover"
          />
          {% else %}
          <div
            class="w-full h-48 bg-[#FFE8CC] text-5xl flex items-center justify-center"
          >
            ğŸ“¸
          </div>
          {% endif %}

          <div class="p-4">
            <h4 class="font-bold text-[#D2691E] truncate">{{ post.title }}</h4>
            <p class="text-sm text-[#8B4513] line-clamp-2 mb-2">
              {{ post.content }}
            </p>

            <button
              id="likeBtn-{{ post.id }}"
              onclick="event.stopPropagation(); toggleLike({{ post.id }})"
              class="flex items-center gap-1 text-sm px-3 py-1 border rounded-full transition {% if post.id in liked_post_ids %} bg-[#FF69B4] text-white border-[#FF69B4] {% else %} bg-white text-[#FF69B4] border-[#FF69B4] {% endif %}"
            >
              <span id="likeIcon-{{ post.id }}">
                {% if post.id in liked_post_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
              </span>
              <span id="likeCount-{{ post.id }}">{{ post.likes.count }}</span>
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</main>

<!-- ===== ê²Œì‹œê¸€ ìƒì„¸ ëª¨ë‹¬ ===== -->
<div
  id="postModal"
  class="hidden fixed inset-0 bg-black/50 snel flex justify-center items-center p-4 z-50"
  onclick="overlayClose(event)"
>
  <div
    class="bg-white max-w-3xl w-full rounded-2xl overflow-hidden relative"
    onclick="event.stopPropagation()"
  >
    <!-- ìš°ì¸¡ ìƒë‹¨ X ë²„íŠ¼ -->
    <button
      onclick="closePostModal()"
      class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full bg-black/60 text-white text-sm hover:bg-black/80 transition"
    >
      âœ•
    </button>

    <div class="grid grid-cols-1 lg:grid-cols-2">
      <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
      <div
        class="bg-black flex items-center justify-center"
        id="modalImageContainer"
      >
        <img id="modalImage" class="w-full h-full object-contain" />
        <span
          id="modalPlaceholder"
          class="text-6xl text-white hidden select-none"
        >
          ğŸ“¸
        </span>
      </div>

      <!-- í…ìŠ¤íŠ¸ / ë²„íŠ¼ / ëŒ“ê¸€ ì˜ì—­ -->
      <div class="p-6 flex flex-col justify-between">
        <div>
          <!-- ë³´ê¸° ì˜ì—­ -->
          <div id="modalViewArea">
            <h3 class="text-2xl font-bold text-[#D2691E]" id="modalTitle"></h3>
            <p class="text-sm text-gray-500 mt-1" id="modalWriter"></p>
            <p class="mt-3 text-[#6B4F2A]" id="modalContent"></p>
          </div>

          <!-- ìˆ˜ì • ì˜ì—­ (ìˆ¨ê¹€) -->
          <div id="modalEditArea" class="hidden space-y-2">
            <input
              id="modalEditTitle"
              type="text"
              class="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FF69B4]"
              placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
            <textarea
              id="modalEditContent"
              rows="4"
              class="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FF69B4]"
              placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
            ></textarea>
            <div class="flex gap-2">
              <button
                type="button"
                onclick="submitPostEdit()"
                class="px-4 py-2 bg-[#FF69B4] text-white rounded-lg text-sm font-bold border-2 border-[#D2691E]"
              >
                ìˆ˜ì • ì €ì¥
              </button>
              <button
                type="button"
                onclick="cancelPostEdit()"
                class="px-4 py-2 bg-white text-[#8B4513] rounded-lg text-sm font-bold border border-[#D2691E]"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>

          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ (ëŒ“ê¸€ ìœ„) -->
          <div class="mt-4">
            <button
              id="modalLikeBtn"
              onclick=""
              class="flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-white text-[#FF69B4] border-[#FF69B4]"
            >
              <span id="modalLikeIcon">ğŸ¤</span>
              <span id="modalLikeCount">0</span>
            </button>
          </div>
        </div>

        <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
        <div class="mt-4">
          <h4 class="font-semibold text-[#D2691E] mb-2">ëŒ“ê¸€</h4>
          <div
            id="modalComments"
            class="max-h-40 overflow-y-auto space-y-2 text-sm"
          >
            <!-- JSë¡œ ì±„ì›Œì§ -->
          </div>
        </div>

        <!-- ëŒ“ê¸€ ì…ë ¥ -->
        <div class="mt-3 flex items-center gap-2">
          <input
            id="commentInput"
            type="text"
            placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
            class="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FF69B4]"
          />
          <button
            type="button"
            onclick="submitComment()"
            class="px-4 py-2 bg-[#FF69B4] text-white rounded-lg text-sm font-bold border-2 border-[#D2691E] hover:bg-[#FF1493] transition"
          >
            ê²Œì‹œ
          </button>
        </div>

        <!-- ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ (ì‘ì„±ìë§Œ ë…¸ì¶œ) -->
        <div id="modalOwnerActions" class="mt-4 hidden flex gap-3 items-center">
          <button
            type="button"
            id="editPostBtn"
            class="text-sm px-3 py-2 rounded-lg bg-[#FF69B4] text-white font-bold border border-[#D2691E]"
          >
            ê²Œì‹œê¸€ ìˆ˜ì •
          </button>
          <form method="post" id="deletePostForm">
            {% csrf_token %}
            <button class="text-red-600 font-bold text-sm">ê²Œì‹œê¸€ ì‚­ì œ</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PROFILE IMAGE UPLOAD MODAL ===== -->
<div
  id="imageModal"
  class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
>
  <div
    class="bg-white p-8 rounded-xl pixel-corners border-4 border-[#D2691E] max-w-md w-full"
  >
    <h2 class="text-2xl font-bold text-center text-[#D2691E] mb-4">
      í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½
    </h2>

    <div
      id="imagePreview"
      class="w-48 h-48 mx-auto bg-[#FFE8CC] rounded-full border-4 border-[#D2691E] flex items-center justify-center overflow-hidden"
    >
      <span class="text-6xl">ğŸ</span>
    </div>

    <input type="file" id="imageInput" accept="image/*" class="hidden" />

    <div class="mt-6 flex gap-3">
      <button
        onclick="document.getElementById('imageInput').click()"
        class="flex-1 bg-[#FF69B4] text-white py-3 rounded-xl font-bold border-2 border-[#D2691E]"
      >
        ì´ë¯¸ì§€ ì„ íƒ
      </button>
      <button
        onclick="uploadImage()"
        id="uploadButton"
        class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold border-2 border-green-700 disabled:opacity-50"
        disabled
      >
        ì—…ë¡œë“œ
      </button>
    </div>

    <button
      onclick="closeImagePopup()"
      class="w-full mt-4 py-3 bg-white text-[#8B4513] border-2 border-[#D2691E] rounded-xl font-bold"
    >
      ì·¨ì†Œ
    </button>
  </div>
</div>
{% endblock content %} {% block extra_script %}
<script>
  let currentPostId = null;
  let selectedImg = null;
  const CSRF_TOKEN = "{{ csrf_token }}";

  function goToProfile(nickname) {
    const encoded = encodeURIComponent(nickname);
    window.location.href = `/users/profile/${encoded}/`;
  }

  /* ==============================
     ì˜¤ë²„ë ˆì´(ë°°ê²½) í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
  ============================== */
  function overlayClose(event) {
    if (event.target.id === "postModal") {
      closePostModal();
    }
  }

  /* ==============================
     íŒ”ë¡œìš° AJAX
  ============================== */
  async function toggleFollow(nickname) {
    try {
      const response = await fetch(`/users/follow/${nickname}/ajax/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
        },
      });

      if (!response.ok) return;

      const data = await response.json();
      if (!data.success) {
        console.error(data.error || "íŒ”ë¡œìš° ì²˜ë¦¬ ì‹¤íŒ¨");
        return;
      }

      const btn = document.getElementById("followBtn");
      const followerCount = document.getElementById("followerCount");

      followerCount.textContent = data.follower_count;

      if (data.is_following) {
        btn.textContent = "âœ” íŒ”ë¡œì‰";
        btn.className =
          "mt-4 px-6 py-3 text-lg font-bold rounded-xl pixel-corners border-3 bg-white text-[#D2691E] border-[#D2691E]";
      } else {
        btn.textContent = "+ íŒ”ë¡œìš°";
        btn.className =
          "mt-4 px-6 py-3 text-lg font-bold rounded-xl pixel-corners border-3 bg-[#FF69B4] text-white border-[#D2691E]";
      }
    } catch (e) {
      console.error("íŒ”ë¡œìš° í† ê¸€ ì—ëŸ¬:", e);
    }
  }

  /* ==============================
     ì¢‹ì•„ìš” AJAX (ì¹´ë“œ)
  ============================== */
  async function toggleLike(postId) {
    try {
      const response = await fetch(`/users/post/${postId}/like-toggle/ajax/`, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN },
      });

      if (!response.ok) return;
      const data = await response.json();

      const btn = document.getElementById(`likeBtn-${postId}`);
      const icon = document.getElementById(`likeIcon-${postId}`);
      const count = document.getElementById(`likeCount-${postId}`);
      const cardEl = document.querySelector(`.post-card[data-id="${postId}"]`);

      if (data.is_liked) {
        icon.textContent = "â¤ï¸";
        btn.className =
          "flex items-center gap-1 text-sm px-3 py-1 border rounded-full bg-[#FF69B4] text-white border-[#FF69B4]";
        if (cardEl) {
          cardEl.dataset.liked = "true";
        }
      } else {
        icon.textContent = "ğŸ¤";
        btn.className =
          "flex items-center gap-1 text-sm px-3 py-1 border rounded-full bg-white text-[#FF69B4] border-[#FF69B4]";
        if (cardEl) {
          cardEl.dataset.liked = "false";
        }
      }

      count.textContent = data.like_count;
      if (cardEl) {
        cardEl.dataset.likes = data.like_count;
      }

      // ëª¨ë‹¬ì´ ì—´ë ¤ ìˆë‹¤ë©´ ëª¨ë‹¬ ìª½ë„ ì—…ë°ì´íŠ¸
      const modal = document.getElementById("postModal");
      if (!modal.classList.contains("hidden") && currentPostId == postId) {
        const modalIcon = document.getElementById("modalLikeIcon");
        const modalBtn = document.getElementById("modalLikeBtn");
        const modalCount = document.getElementById("modalLikeCount");

        modalCount.textContent = data.like_count;
        if (data.is_liked) {
          modalIcon.textContent = "â¤ï¸";
          modalBtn.className =
            "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-[#FF69B4] text-white border-[#FF69B4]";
        } else {
          modalIcon.textContent = "ğŸ¤";
          modalBtn.className =
            "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-white text-[#FF69B4] border-[#FF69B4]";
        }
      }
    } catch (e) {
      console.error("ì¢‹ì•„ìš” í† ê¸€ ì—ëŸ¬:", e);
    }
  }

  /* ==============================
     ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
  ============================== */
  function resetPostEditMode() {
    document.getElementById("modalViewArea").classList.remove("hidden");
    document.getElementById("modalEditArea").classList.add("hidden");
  }

  function enterPostEditMode() {
    document.getElementById("modalViewArea").classList.add("hidden");
    document.getElementById("modalEditArea").classList.remove("hidden");
  }

  function cancelPostEdit() {
    resetPostEditMode();
  }

  function openPostModal(el) {
    const id = el.dataset.id;
    currentPostId = id;

    const imgUrl = el.dataset.img;
    const title = el.dataset.title;
    const content = el.dataset.content;
    const writerUser = el.dataset.writer;
    const likeCount = parseInt(el.dataset.likes, 10) || 0;
    const liked = el.dataset.liked === "true";

    document.getElementById("postModal").classList.remove("hidden");

    const modalImg = document.getElementById("modalImage");
    const modalPlaceholder = document.getElementById("modalPlaceholder");

    if (imgUrl) {
      modalImg.src = imgUrl;
      modalImg.classList.remove("hidden");
      modalPlaceholder.classList.add("hidden");
    } else {
      modalImg.src = "";
      modalImg.classList.add("hidden");
      modalPlaceholder.classList.remove("hidden");
    }

    // ë³´ê¸° ì˜ì—­ ë°ì´í„°
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalWriter").textContent = "@" + writerUser;
    document.getElementById("modalContent").textContent = content;
    document.getElementById("modalLikeCount").textContent = likeCount;

    // ìˆ˜ì • ì˜ì—­ ê¸°ë³¸ê°’
    document.getElementById("modalEditTitle").value = title;
    document.getElementById("modalEditContent").value = content;

    const icon = document.getElementById("modalLikeIcon");
    const btn = document.getElementById("modalLikeBtn");

    if (liked) {
      icon.textContent = "â¤ï¸";
      btn.className =
        "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-[#FF69B4] text-white border-[#FF69B4]";
    } else {
      icon.textContent = "ğŸ¤";
      btn.className =
        "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-white text-[#FF69B4] border-[#FF69B4]";
    }

    btn.setAttribute("onclick", `toggleModalLike(${id})`);

    const ownerActions = document.getElementById("modalOwnerActions");
    if ("{{ user.username }}" === writerUser) {
      ownerActions.classList.remove("hidden");
      document.getElementById(
        "deletePostForm"
      ).action = `/users/post/${id}/delete/`;
      document.getElementById("editPostBtn").onclick = enterPostEditMode;
    } else {
      ownerActions.classList.add("hidden");
    }

    // ë³´ê¸° ëª¨ë“œë¡œ ì´ˆê¸°í™”
    resetPostEditMode();

    // ëŒ“ê¸€ ë¡œë”©
    loadComments(id);
  }

  function closePostModal() {
    const input = document.getElementById("commentInput");
    if (input) input.value = "";
    document.getElementById("modalComments").innerHTML = "";
    document.getElementById("postModal").classList.add("hidden");
  }

  /* ==============================
     ê²Œì‹œê¸€ ìˆ˜ì • ì €ì¥ AJAX
  ============================== */
  async function submitPostEdit() {
    if (!currentPostId) return;

    const titleInput = document.getElementById("modalEditTitle");
    const contentInput = document.getElementById("modalEditContent");

    const title = titleInput.value.trim();
    const content = contentInput.value.trim();

    if (!title) {
      alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    try {
      const res = await fetch(`/users/post/${currentPostId}/update/ajax/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ title, content }),
      });

      const data = await res.json();
      if (!data.success) {
        alert(data.error || "ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      document.getElementById("modalTitle").textContent = data.post.title;
      document.getElementById("modalContent").textContent = data.post.content;

      const cardEl = document.querySelector(
        `.post-card[data-id="${currentPostId}"]`
      );
      if (cardEl) {
        cardEl.dataset.title = data.post.title;
        cardEl.dataset.content = data.post.content;

        const titleEl = cardEl.querySelector("h4");
        const contentEl = cardEl.querySelector("p.text-sm");
        if (titleEl) titleEl.textContent = data.post.title;
        if (contentEl) contentEl.textContent = data.post.content;
      }

      resetPostEditMode();
      alert("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
      console.error("ê²Œì‹œê¸€ ìˆ˜ì • ì—ëŸ¬:", e);
      alert("ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ==============================
     ëŒ“ê¸€ ë Œë”ë§ ê³µí†µ í•¨ìˆ˜
  ============================== */
  function renderComment(c) {
    const wrap = document.getElementById("modalComments");
    const div = document.createElement("div");
    div.className = "flex items-start gap-2";
    div.dataset.commentId = c.id;

    let ownerButtons = "";
    if (c.is_owner) {
      ownerButtons = `
      <div class="mt-1 space-x-2 text-[11px] text-gray-400">
        <button type="button"
                onclick="startEditComment(${c.id})"
                class="hover:underline">
          ìˆ˜ì •
        </button>
        <button type="button"
                onclick="deleteComment(${c.id})"
                class="hover:underline text-red-500">
          ì‚­ì œ
        </button>
      </div>
    `;
    }

    div.innerHTML = `
    <div class="flex-1">
      <a
        href="/users/profile/${encodeURIComponent(c.writer_nickname)}/"
        class="font-semibold text-[#D2691E] text-xs hover:underline"
      >
        @${c.writer_nickname}
      </a>
      <p id="commentContent-${c.id}"
         class="text-sm text-[#6B4F2A] break-words">
        ${c.content}
      </p>
      <p class="text-[10px] text-gray-400">${c.created_at}</p>
      <div id="commentButtons-${c.id}">
        ${ownerButtons}
      </div>
    </div>
  `;

    wrap.appendChild(div);
  }

  /* ==============================
     ëŒ“ê¸€ ëª©ë¡ ë¡œë”©
  ============================== */
  async function loadComments(postId) {
    try {
      const res = await fetch(`/users/post/${postId}/comments/ajax/`);
      if (!res.ok) return;

      const data = await res.json();
      const wrap = document.getElementById("modalComments");
      wrap.innerHTML = "";

      if (!data.comments || data.comments.length === 0) {
        wrap.innerHTML =
          '<p class="text-xs text-gray-400">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
        return;
      }

      data.comments.forEach((c) => {
        renderComment(c); // ğŸ”¥ ì—¬ê¸°
      });
    } catch (e) {
      console.error("ëŒ“ê¸€ ë¡œë”© ì—ëŸ¬:", e);
    }
  }

  /* ==============================
     ëŒ“ê¸€ ë“±ë¡ AJAX
  ============================== */
  async function submitComment() {
    const input = document.getElementById("commentInput");
    const content = input.value.trim();
    if (!content) return;
    if (!currentPostId) return;

    try {
      const res = await fetch(`/users/post/${currentPostId}/comments/ajax/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ content: content }),
      });

      const data = await res.json();

      if (!data.success) {
        alert(data.error || "ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      input.value = "";
      renderComment(data.comment); // ğŸ”¥ ìƒˆ ëŒ“ê¸€ë„ ë™ì¼í•˜ê²Œ ë Œë”
    } catch (e) {
      console.error("ëŒ“ê¸€ ë“±ë¡ ì—ëŸ¬:", e);
      alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ==============================
     ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ JS
  ============================== */
  function startEditComment(commentId) {
    const contentEl = document.getElementById(`commentContent-${commentId}`);
    const oldContent = contentEl.textContent;

    // inputìœ¼ë¡œ ì „í™˜
    contentEl.innerHTML = `
    <input id="editInput-${commentId}"
           type="text"
           value="${oldContent}"
           class="w-full px-2 py-1 border rounded text-sm">
  `;

    // ìˆ˜ì • / ì·¨ì†Œ ë²„íŠ¼ ìƒì„±
    const btnArea = document.getElementById(`commentButtons-${commentId}`);
    btnArea.innerHTML = `
    <button onclick="saveEditComment(${commentId})"
            class="text-xs text-green-600 font-bold hover:underline">
      ì €ì¥
    </button>
    <button onclick="cancelEditComment(${commentId}, '${oldContent.replace(
      /'/g,
      "\\'"
    )}')"
            class="text-xs text-gray-500 hover:underline">
      ì·¨ì†Œ
    </button>
  `;
  }

  async function saveEditComment(commentId) {
    const inputEl = document.getElementById(`editInput-${commentId}`);
    const newContent = inputEl.value.trim();
    if (!newContent) return;

    try {
      const res = await fetch(`/users/comment/${commentId}/edit/ajax/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ content: newContent }),
      });

      const data = await res.json();
      if (!data.success) {
        alert(data.error || "ìˆ˜ì • ì‹¤íŒ¨");
        return;
      }

      const contentEl = document.getElementById(`commentContent-${commentId}`);
      contentEl.textContent = newContent;

      // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
      document.getElementById(`commentButtons-${commentId}`).innerHTML = `
      <button onclick="startEditComment(${commentId})"
              class="hover:underline text-xs">
        ìˆ˜ì •
      </button>
      <button onclick="deleteComment(${commentId})"
              class="hover:underline text-xs text-red-500">
        ì‚­ì œ
      </button>
    `;
    } catch (e) {
      console.error("ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨:", e);
    }
  }

  function cancelEditComment(commentId, oldContent) {
    const contentEl = document.getElementById(`commentContent-${commentId}`);
    contentEl.textContent = oldContent;

    document.getElementById(`commentButtons-${commentId}`).innerHTML = `
    <button onclick="startEditComment(${commentId})"
            class="hover:underline text-xs">
      ìˆ˜ì •
    </button>
    <button onclick="deleteComment(${commentId})"
            class="hover:underline text-xs text-red-500">
      ì‚­ì œ
    </button>
  `;
  }

  function deleteComment(commentId) {
    if (!confirm("ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/users/comment/${commentId}/delete/ajax/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": CSRF_TOKEN,
      },
    })
      .then((res) => res.json())
      .then((data) => {
        if (!data.success) {
          alert(data.error || "ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        const commentEl = document.querySelector(
          `div[data-comment-id="${commentId}"]`
        );
        if (commentEl) {
          commentEl.remove();
        }
      })
      .catch((e) => {
        console.error("ëŒ“ê¸€ ì‚­ì œ ì—ëŸ¬:", e);
      });
  }

  /* ==============================
     ì¢‹ì•„ìš” AJAX (ëª¨ë‹¬ ë‚´ë¶€)
  ============================== */
  async function toggleModalLike(postId) {
    try {
      const response = await fetch(`/users/post/${postId}/like-toggle/ajax/`, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN },
      });

      if (!response.ok) return;
      const data = await response.json();

      // ëª¨ë‹¬ UI
      const modalCount = document.getElementById("modalLikeCount");
      const modalIcon = document.getElementById("modalLikeIcon");
      const modalBtn = document.getElementById("modalLikeBtn");

      modalCount.textContent = data.like_count;

      if (data.is_liked) {
        modalIcon.textContent = "â¤ï¸";
        modalBtn.className =
          "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-[#FF69B4] text-white border-[#FF69B4]";
      } else {
        modalIcon.textContent = "ğŸ¤";
        modalBtn.className =
          "flex items-center gap-2 text-lg px-4 py-2 rounded-full border-2 bg-white text-[#FF69B4] border-[#FF69B4]";
      }

      // ì¹´ë“œ UI
      const icon = document.getElementById(`likeIcon-${postId}`);
      const count = document.getElementById(`likeCount-${postId}`);
      const btn = document.getElementById(`likeBtn-${postId}`);
      const cardEl = document.querySelector(`.post-card[data-id="${postId}"]`);

      if (data.is_liked) {
        icon.textContent = "â¤ï¸";
        btn.className =
          "flex items-center gap-1 text-sm px-3 py-1 border rounded-full bg-[#FF69B4] text-white border-[#FF69B4]";
        if (cardEl) cardEl.dataset.liked = "true";
      } else {
        icon.textContent = "ğŸ¤";
        btn.className =
          "flex items-center gap-1 text-sm px-3 py-1 border rounded-full bg-white text-[#FF69B4] border-[#FF69B4]";
        if (cardEl) cardEl.dataset.liked = "false";
      }

      count.textContent = data.like_count;
      if (cardEl) {
        cardEl.dataset.likes = data.like_count;
      }
    } catch (e) {
      console.error("ëª¨ë‹¬ ì¢‹ì•„ìš” í† ê¸€ ì—ëŸ¬:", e);
    }
  }

  /* ==============================
     í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ëª¨ë‹¬
  ============================== */
  function openImagePopup() {
    document.getElementById("imageModal").classList.remove("hidden");
  }

  function closeImagePopup() {
    document.getElementById("imageModal").classList.add("hidden");
  }

  document.getElementById("imageInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    selectedImg = file;
    const reader = new FileReader();
    reader.onload = (evt) => {
      document.getElementById(
        "imagePreview"
      ).innerHTML = `<img src="${evt.target.result}" class="w-full h-full object-cover">`;
      document.getElementById("uploadButton").disabled = false;
    };
    reader.readAsDataURL(file);
  });

  async function uploadImage() {
    if (!selectedImg) return;
    const reader = new FileReader();
    reader.onloadend = async function () {
      const response = await fetch("{% url 'users:upload_profile_image' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ image: reader.result }),
      });

      const data = await response.json();
      if (data.success) {
        document.getElementById("profileImage").src =
          data.image_url + "?t=" + new Date().getTime();
        closeImagePopup();
      } else {
        alert(data.error || "í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    };
    reader.readAsDataURL(selectedImg);
  }

  /* ==============================
     ëŒ“ê¸€ input ì—”í„°í‚¤ë¡œ ì „ì†¡
  ============================== */
  document.addEventListener("DOMContentLoaded", function () {
    const commentInput = document.getElementById("commentInput");
    if (commentInput) {
      commentInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          submitComment();
        }
      });
    }
  });

  /* ==============================
     íŒ”ë¡œìš°/íŒ”ë¡œì‰ ëª¨ë‹¬
  ============================== */
  function closeFollowModal() {
    const modal = document.getElementById("followModal");
    if (modal) modal.classList.add("hidden");
  }

  async function openFollowModal(type) {
    const modal = document.getElementById("followModal");
    const titleEl = document.getElementById("followModalTitle");
    const listEl = document.getElementById("followList");

    if (!modal || !titleEl || !listEl) return;

    const nickname = "{{ target_user.nickname|escapejs }}";

    let url = "";
    if (type === "followers") {
      titleEl.textContent = "íŒ”ë¡œì›Œ";
      url = `/users/profile/${encodeURIComponent(nickname)}/followers/ajax/`;
    } else {
      titleEl.textContent = "íŒ”ë¡œì‰";
      url = `/users/profile/${encodeURIComponent(nickname)}/followings/ajax/`;
    }

    modal.classList.remove("hidden");
    listEl.innerHTML = '<p class="text-gray-400 text-xs">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    try {
      const res = await fetch(url);
      if (!res.ok) {
        listEl.innerHTML =
          '<p class="text-red-500 text-xs">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const data = await res.json();
      const users = data.users || [];

      if (users.length === 0) {
        listEl.innerHTML =
          '<p class="text-gray-400 text-xs">ì•„ì§ ì•„ë¬´ë„ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      listEl.innerHTML = "";

      users.forEach((u) => {
        const div = document.createElement("div");
        div.className = "flex items-center gap-3";

        const profileImg = u.profile_img
          ? `<img src="${u.profile_img}" class="w-8 h-8 rounded-full object-cover border" />`
          : `<div class="w-8 h-8 rounded-full bg-[#FFE8CC] flex items-center justify-center text-lg">ğŸ</div>`;

        div.innerHTML = `
          ${profileImg}
          <div class="flex-1">
            <a
              href="/users/profile/${encodeURIComponent(u.nickname)}/"
              class="font-semibold text-[#D2691E] hover:underline text-sm"
            >
              ${u.nickname}
            </a>
            <p class="text-[11px] text-gray-500">@${u.username}</p>
          </div>
        `;

        listEl.appendChild(div);
      });
    } catch (e) {
      console.error("íŒ”ë¡œìš° ëª©ë¡ ë¡œë”© ì—ëŸ¬:", e);
      listEl.innerHTML =
        '<p class="text-red-500 text-xs">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }
</script>
{% endblock extra_script %}
